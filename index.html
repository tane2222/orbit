<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Nexus - Connected</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- CSS Design (前回と同じクールなデザイン) --- */
        :root {
            --bg-color: #0b0c10;
            --sidebar-bg: rgba(31, 40, 51, 0.9);
            --accent-cyan: #66fcf1;
            --accent-dark-cyan: #45a29e;
            --text-main: #c5c6c7;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        #network { width: 100%; height: 100vh; background: radial-gradient(circle at center, #1a1a2e 0%, #0b0c10 100%); }
        
        /* Top Bar */
        .top-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10; display: flex; gap: 10px; background: var(--sidebar-bg); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(10px); border: var(--glass-border); box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 60%; max-width: 600px; }
        input#search-input { background: transparent; border: none; color: white; font-size: 1rem; flex-grow: 1; outline: none; }
        button.action-btn { background: var(--accent-dark-cyan); border: none; color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        button.action-btn:hover { background: var(--accent-cyan); color: black; box-shadow: 0 0 10px var(--accent-cyan); }
        
        /* Agent Console */
        .agent-console { position: absolute; bottom: 20px; right: 20px; width: 350px; height: 300px; background: var(--sidebar-bg); border-radius: 10px; border: var(--glass-border); backdrop-filter: blur(10px); z-index: 10; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(102, 252, 241, 0.1); }
        .console-header { background: rgba(0,0,0,0.3); padding: 10px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; color: var(--accent-cyan); border-bottom: var(--glass-border); }
        .console-body { flex-grow: 1; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.8rem; overflow-y: auto; color: #d1d1d1; display: flex; flex-direction: column; gap: 5px; }
        .log-entry { opacity: 0; animation: fadeIn 0.3s forwards; word-wrap: break-word; }
        .log-entry.ai { color: var(--accent-cyan); }
        .log-entry.system { color: #f0ad4e; }
        .log-entry.error { color: #ff6b6b; }
        
        /* Info Panel */
        .info-panel { position: absolute; top: 100px; left: 20px; width: 300px; max-height: 70vh; overflow-y: auto; background: var(--sidebar-bg); border-radius: 10px; padding: 20px; border: var(--glass-border); backdrop-filter: blur(10px); z-index: 10; transform: translateX(-400px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .info-panel.active { transform: translateX(0); }
        .info-panel h2 { color: var(--accent-cyan); margin-top: 0; }
        .info-panel p { line-height: 1.6; font-size: 0.9rem; white-space: pre-wrap; }
        .tag { display: inline-block; background: rgba(102, 252, 241, 0.2); color: var(--accent-cyan); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; margin-bottom: 5px; }
        .controls { margin-top: 15px; display: flex; gap: 10px; }

        /* API Settings Modal (Hidden by default) */
        #settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1f2833; padding: 30px; border-radius: 10px; border: 1px solid var(--accent-cyan); width: 400px; color: white; }
        .modal-content input { width: 95%; padding: 8px; margin: 10px 0; background: #0b0c10; border: 1px solid #45a29e; color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: red; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: #66fcf1; box-shadow: 0 0 5px #66fcf1; }

        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="network"></div>

    <div class="top-bar">
        <i class="fas fa-search" style="color: var(--accent-cyan); align-self: center;"></i>
        <input type="text" id="search-input" placeholder="調査トピックを入力 (例: Web3, 生成AI)...">
        <button class="action-btn" id="search-btn">Research</button>
    </div>

    <div class="info-panel" id="info-panel">
        <h2 id="panel-title">Node Title</h2>
        <div id="panel-tags"></div>
        <p id="panel-desc">Loading...</p>
        <div class="controls">
            <button class="action-btn" style="background: #e94560;" onclick="deleteNode()">Delete</button>
            <button class="action-btn" onclick="closePanel()">Close</button>
        </div>
    </div>

    <div class="agent-console">
        <div class="console-header">
            <span><i class="fas fa-robot"></i> AGENT LOG</span>
            <div style="cursor: pointer;" onclick="toggleSettings()"><i class="fas fa-cog"></i> Config</div>
        </div>
        <div class="console-body" id="console-logs">
            <div class="log-entry system">> System initialized.</div>
            <div class="log-entry system">> <span class="status-dot" id="db-status"></span>Database: Disconnected</div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h3>API Configurations</h3>
            <p style="font-size: 0.8rem; color: #ccc;">入力されたキーはブラウザにのみ保存されます。</p>
            
            <label>AI API Key (Gemini or OpenAI)</label>
　　　　　　　<input type="password" id="openai-key" placeholder="AI Studioで取得したキー (AIza...)" onchange="this.value = this.value.trim()">
            
            <label>Google Search API Key</label>
            <input type="password" id="google-key" placeholder="AIza...">
            
            <label>Google Search Engine ID (CX)</label>
            <input type="text" id="google-cx" placeholder="012345...">
            
            <label>Firebase Config (JSON object)</label>
            <textarea id="firebase-config" rows="5" style="width:95%; background:#0b0c10; color:white; border:1px solid #45a29e;" placeholder='{"apiKey": "...", "authDomain": "...", "databaseURL": "..."}'></textarea>

            <button class="action-btn" onclick="saveSettings()">Save & Connect</button>
            <button class="action-btn" style="background:#555;" onclick="toggleSettings()">Cancel</button>
        </div>
    </div>

    <script type="module">
        // --- Imports for Firebase (v9 Modular) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- Global Variables ---
        let network, nodes, edges;
        let db; // Firebase Database instance
        let CONFIG = {
            openai: localStorage.getItem('openai_key') || '',
            googleKey: localStorage.getItem('google_key') || '',
            googleCx: localStorage.getItem('google_cx') || '',
            firebase: JSON.parse(localStorage.getItem('firebase_config') || '{}')
        };

        // --- 1. Initialize Vis.js (Graph UI) ---
        function initGraph() {
            nodes = new vis.DataSet([]);
            edges = new vis.DataSet([]);

            const container = document.getElementById('network');
            const data = { nodes: nodes, edges: edges };
            const options = {
                nodes: { shape: 'dot', size: 20, font: { size: 14, color: '#ffffff' }, borderWidth: 2, shadow: true },
                edges: { width: 2, color: { color: '#45a29e', highlight: '#66fcf1' }, smooth: { type: "continuous" } },
                groups: {
                    core: { color: { background: '#e94560', border: '#e94560' }, size: 30 },
                    result: { color: { background: '#66fcf1', border: '#66fcf1' } },
                    ai: { color: { background: '#f0ad4e', border: '#f0ad4e' } }
                },
                physics: { stabilization: false, barnesHut: { gravitationalConstant: -4000 } },
                interaction: { hover: true }
            };
            network = new vis.Network(container, data, options);

            // Interaction
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeData = nodes.get(params.nodes[0]);
                    showPanel(nodeData);
                } else {
                    document.getElementById('info-panel').classList.remove('active');
                }
            });
        }

        // --- 2. Firebase Integration (Database) ---
        function initFirebase() {
            if (!CONFIG.firebase.apiKey) return;
            
            try {
                const app = initializeApp(CONFIG.firebase);
                db = getDatabase(app);
                logToConsole("Connecting to Firebase...", "system");

                const graphRef = ref(db, 'knowledge-graph');
                
                // Realtime Sync: Firebase -> Local Vis.js
                onValue(graphRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // 差分更新ではなく、シンプルに全置換で同期（デモ用）
                        // 実際はID比較でUpdateするほうが効率的
                        const newNodes = data.nodes ? Object.values(data.nodes) : [];
                        const newEdges = data.edges ? Object.values(data.edges) : [];
                        
                        nodes.clear();
                        edges.clear();
                        nodes.add(newNodes);
                        edges.add(newEdges);
                        
                        document.getElementById('db-status').classList.add('online');
                        logToConsole("Database synced.", "system");
                    }
                });

            } catch (e) {
                logToConsole("Firebase Error: " + e.message, "error");
            }
        }

        // Save to Firebase
        function saveToDB() {
            if (!db) return;
            // Vis.jsのデータをオブジェクト形式に変換して保存
            const nodesObj = {};
            const edgesObj = {};
            nodes.forEach(n => nodesObj[n.id] = n);
            edges.forEach(e => edgesObj[e.id] = e);

            set(ref(db, 'knowledge-graph'), {
                nodes: nodesObj,
                edges: edgesObj
            }).catch(e => logToConsole("Save Failed: " + e.message, "error"));
        }

        // --- 3. Web Search Logic (Google Custom Search API) ---
        async function performWebSearch(query) {
            if (!CONFIG.googleKey || !CONFIG.googleCx) {
                logToConsole("Missing Google API Keys.", "error");
                return null;
            }

            logToConsole(`Searching: "${query}"...`, "ai");
            const url = `https://www.googleapis.com/customsearch/v1?key=${CONFIG.googleKey}&cx=${CONFIG.googleCx}&q=${encodeURIComponent(query)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                return data.items || [];
            } catch (e) {
                logToConsole("Search Error: " + e.message, "error");
                return [];
            }
        }

       // --- 4. AI Summary Logic (Gemini API Optimized) ---
async function getAISummary(topic, searchResults) {
    // 設定画面のキーを取得し、空白を除去
    const apiKey = (CONFIG.openai || "").trim(); 
    
    if (!apiKey) {
        return "API Key is missing. Please check Config.";
    }

    logToConsole(`Gemini thinking about "${topic}"...`, "ai");

    // コンテキストの作成
    const context = searchResults.slice(0, 3).map(item => `- ${item.title}: ${item.snippet}`).join("\n");
    
    const prompt = `
    Topic: ${topic}
    Context:
    ${context}
    
    Task: Summarize the relationship between these concepts and the topic in Japanese. Be concise (max 100 words). Format as plain text.`;

    // Gemini 2.5 Flash Endpoint
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

    try {
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });
        
        const json = await res.json();
        
        // 詳細なエラーハンドリング
        if (json.error) {
            console.error("Gemini API Error Details:", json); // ブラウザのコンソール(F12)にも出す
            throw new Error(json.error.message || "Invalid API Response");
        }
        
        // テキスト抽出
        const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) throw new Error("No text generated.");

        return text;

    } catch (e) {
        logToConsole("Gemini Error: " + e.message, "error");
        return "AI processing failed. Check API Key.";
    }
}

        // --- 5. Orchestration (The "Trigger" Function) ---
        async function triggerSearch() {
            const input = document.getElementById('search-input');
            const term = input.value;
            if (!term) return;

            input.value = ""; // Clear input

            // 1. Create Core Node
            const centerId = `node_${Date.now()}`;
            const centerNode = {
                id: centerId,
                label: term,
                group: 'core',
                description: 'Fetching data...',
                x: 0, y: 0
            };
            
            // Local update first
            nodes.add(centerNode);
            if (db) saveToDB(); // Sync

            // 2. Perform Web Search
            const results = await performWebSearch(term);
            if (!results) return;

            // 3. Create Child Nodes from Search
            const newNodes = [];
            const newEdges = [];

            // Add top 3 results as nodes
            results.slice(0, 3).forEach((item, index) => {
                const childId = `${centerId}_child_${index}`;
                newNodes.push({
                    id: childId,
                    label: item.title.substring(0, 15) + "...",
                    group: 'result',
                    title: item.title,
                    description: item.snippet,
                    url: item.link
                });
                newEdges.push({
                    id: `${centerId}_edge_${index}`,
                    from: centerId,
                    to: childId
                });
            });

            // 4. Get AI Summary for Center Node
            const summary = await getAISummary(term, results);
            centerNode.description = summary;
            
            // Update Data
            nodes.update(centerNode);
            nodes.add(newNodes);
            edges.add(newEdges);
            
            // 5. Final Sync
            if (db) saveToDB();
            
            logToConsole("Knowledge graph updated.", "system");
        }

        // --- Helper UI Functions ---
        window.showPanel = function(node) {
            document.getElementById('panel-title').innerText = node.label;
            document.getElementById('panel-desc').innerText = node.description || "No description.";
            
            let html = `<span class="tag">${node.group}</span>`;
            if (node.url) html += `<br><a href="${node.url}" target="_blank" style="color:#66fcf1;">Open Link <i class="fas fa-external-link-alt"></i></a>`;
            document.getElementById('panel-tags').innerHTML = html;
            
            document.getElementById('info-panel').classList.add('active');
            window.currentNodeId = node.id;
        }

        window.closePanel = function() {
            document.getElementById('info-panel').classList.remove('active');
            network.unselectAll();
        }

        window.deleteNode = function() {
            if (window.currentNodeId) {
                const relatedEdges = network.getConnectedEdges(window.currentNodeId);
                nodes.remove(window.currentNodeId);
                edges.remove(relatedEdges);
                closePanel();
                if (db) saveToDB(); // Sync delete
                logToConsole("Node deleted.", "system");
            }
        }

        window.logToConsole = function(text, type = "ai") {
            const consoleBody = document.getElementById('console-logs');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `> ${text}`;
            consoleBody.appendChild(div);
            consoleBody.scrollTop = consoleBody.scrollHeight;
        }

        // Settings Modal Control
        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            
            // Fill current values
            if(modal.style.display === 'flex'){
                document.getElementById('openai-key').value = CONFIG.openai;
                document.getElementById('google-key').value = CONFIG.googleKey;
                document.getElementById('google-cx').value = CONFIG.googleCx;
                document.getElementById('firebase-config').value = JSON.stringify(CONFIG.firebase, null, 2);
            }
        }

        window.saveSettings = function() {
    // .trim() を追加して保存時にスペースを削除
    CONFIG.openai = document.getElementById('openai-key').value.trim();
    CONFIG.googleKey = document.getElementById('google-key').value.trim();
    CONFIG.googleCx = document.getElementById('google-cx').value.trim();
    
    try {
        const fbValue = document.getElementById('firebase-config').value.trim();
        CONFIG.firebase = fbValue ? JSON.parse(fbValue) : {};
    } catch(e) {
        alert("Firebase Config JSON format is invalid!");
        return;
    }

    // Save to LocalStorage
    localStorage.setItem('openai_key', CONFIG.openai);
    localStorage.setItem('google_key', CONFIG.googleKey);
    localStorage.setItem('google_cx', CONFIG.googleCx);
    localStorage.setItem('firebase_config', JSON.stringify(CONFIG.firebase));

    toggleSettings();
    logToConsole("Configuration saved. Reloading...", "system");
    setTimeout(() => location.reload(), 1000);
}

        // --- Start Up ---
        document.getElementById('search-btn').addEventListener('click', triggerSearch);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') triggerSearch();
        });

        initGraph();
        initFirebase(); // Try connecting if config exists

    </script>
</body>
</html>
